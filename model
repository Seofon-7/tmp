<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="SpcToolRank.aspx.cs" Inherits="SpcToolManagement.SpcToolRank" %>

<%@ Register Assembly="DevExpress.Web.v19.2, Version=19.2.0.0, Culture=neutral, PublicKeyToken=b88d1754d700e49a"
    Namespace="DevExpress.Web" TagPrefix="dx" %>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>SPC Tool Rank Management</title>
    <style type="text/css">
        .main-container {
            width: 95%;
            margin: 0 auto;
            padding: 20px;
        }
        .popup-form {
            padding: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .frequency-container {
            display: flex;
            align-items: center;
        }
        .frequency-container > div {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <form id="form1" runat="server">
        <div class="main-container">
            <h2>SPC Tool Rank Management</h2>
            
            <dx:ASPxGridView ID="gridSpcToolRank" runat="server" KeyFieldName="ID" Width="100%"
                OnRowInserting="gridSpcToolRank_RowInserting"
                OnRowUpdating="gridSpcToolRank_RowUpdating"
                OnRowDeleting="gridSpcToolRank_RowDeleting"
                OnCustomButtonCallback="gridSpcToolRank_CustomButtonCallback">
                <Settings ShowFilterRow="true" ShowGroupPanel="false" />
                <SettingsSearchPanel Visible="true" />
                <SettingsFilterControl ViewMode="VisualAndText" AllowHierarchicalColumns="true" />
                <SettingsAdaptivity AdaptivityMode="HideDataCells" />
                <SettingsDataSecurity AllowDelete="true" AllowEdit="true" AllowInsert="true" />
                <SettingsBehavior AllowFocusedRow="true" ConfirmDelete="true" />
                <SettingsPager PageSize="20" />
                <SettingsEditing Mode="Inline" />
                
                <Toolbars>
                    <dx:GridViewToolbar>
                        <Items>
                            <dx:GridViewToolbarItem Command="New" Text="新增" />
                            <dx:GridViewToolbarItem Name="SaveAll" Text="儲存" BeginGroup="true" />
                            <dx:GridViewToolbarItem Name="SearchPanel" BeginGroup="true">
                                <Template>
                                    <div style="display: flex; align-items: center;">
                                        <span style="margin-right: 5px;">CHP_GRP:</span>
                                        <dx:ASPxTextBox ID="txtSearch" runat="server" Width="150px" NullText="輸入CHP_GRP..." ClientInstanceName="txtSearch">
                                            <ClientSideEvents KeyPress="function(s, e) {
                                                if(e.htmlEvent.keyCode == 13) {
                                                    searchGrid();
                                                    ASPxClientUtils.PreventEventAndBubble(e.htmlEvent);
                                                }
                                            }" />
                                        </dx:ASPxTextBox>
                                        <dx:ASPxButton ID="btnSearch" runat="server" Text="搜尋" AutoPostBack="false">
                                            <ClientSideEvents Click="function(s, e) { searchGrid(); }" />
                                        </dx:ASPxButton>
                                    </div>
                                </Template>
                            </dx:GridViewToolbarItem>
                        </Items>
                    </dx:GridViewToolbar>
                </Toolbars>
                
                <Columns>
                    <dx:GridViewCommandColumn ShowEditButton="true" ShowDeleteButton="true" Width="80px">
                        <CustomButtons>
                            <dx:GridViewCommandColumnCustomButton ID="btnAdd" Text="複製新增" />
                        </CustomButtons>
                    </dx:GridViewCommandColumn>
                    
                    <dx:GridViewDataTextColumn FieldName="ID" Caption="ID" Visible="false">
                    </dx:GridViewDataTextColumn>
                    
                    <dx:GridViewDataComboBoxColumn FieldName="CHP_GRP" Caption="CHP_GRP" Width="150px">
                        <PropertiesComboBox EnableSynchronization="False" IncrementalFilteringMode="StartsWith"
                            TextField="CHP_GRP" ValueField="CHP_GRP" DataSourceID="dsFlowMapping" EnableCallbackMode="true">
                            <ClientSideEvents Init="function(s, e) { s.AddItems(s.GetGridView().cpChpGrpItems); }" />
                            <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                        </PropertiesComboBox>
                        <Settings FilterMode="DisplayText" AutoFilterCondition="Contains" />
                    </dx:GridViewDataComboBoxColumn>
                    
                    <dx:GridViewDataTextColumn FieldName="LAYER" Caption="LAYER" Width="100px">
                        <PropertiesTextEdit>
                            <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                        </PropertiesTextEdit>
                        <Settings FilterMode="DisplayText" AutoFilterCondition="Contains" />
                    </dx:GridViewDataTextColumn>
                    
                    <dx:GridViewDataTextColumn FieldName="OPE_NO" Caption="OPE_NO" Width="100px">
                        <PropertiesTextEdit>
                            <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                        </PropertiesTextEdit>
                        <Settings FilterMode="DisplayText" AutoFilterCondition="Contains" />
                    </dx:GridViewDataTextColumn>
                    
                    <dx:GridViewDataTextColumn FieldName="PR" Caption="PR" Width="100px">
                        <PropertiesTextEdit>
                            <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                        </PropertiesTextEdit>
                        <Settings FilterMode="DisplayText" AutoFilterCondition="Contains" />
                    </dx:GridViewDataTextColumn>
                    
                    <dx:GridViewDataTextColumn FieldName="FREQUENCY" Caption="頻率" Width="150px">
                        <PropertiesTextEdit>
                            <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                        </PropertiesTextEdit>
                        <Settings FilterMode="DisplayText" AutoFilterCondition="Contains" />
                        <EditItemTemplate>
                            <div class="frequency-container">
                                <div>
                                    <dx:ASPxSpinEdit ID="seFrequencyCount" runat="server" Width="60px" MinValue="1" Value='<%# GetFrequencyCount(Eval("FREQUENCY")) %>'>
                                    </dx:ASPxSpinEdit>
                                </div>
                                <div>次 / </div>
                                <div>
                                    <dx:ASPxComboBox ID="cboFrequencyType" runat="server" Width="80px" Value='<%# GetFrequencyType(Eval("FREQUENCY")) %>'>
                                        <Items>
                                            <dx:ListEditItem Text="天" Value="天" />
                                            <dx:ListEditItem Text="週" Value="週" />
                                        </Items>
                                    </dx:ASPxComboBox>
                                </div>
                                <div>
                                    <dx:ASPxSpinEdit ID="seFrequencyValue" runat="server" Width="60px" MinValue="1" Value='<%# GetFrequencyValue(Eval("FREQUENCY")) %>'>
                                    </dx:ASPxSpinEdit>
                                </div>
                            </div>
                        </EditItemTemplate>
                    </dx:GridViewDataTextColumn>
                </Columns>
                
                <ClientSideEvents ToolbarItemClick="function(s, e) {
                    if (e.item.name === 'SaveAll') {
                        saveAllData();
                    }
                }" />
            </dx:ASPxGridView>
            
            <dx:ASPxPopupControl ID="popupAddEdit" runat="server" HeaderText="新增資料" Width="500px" 
                Modal="true" PopupHorizontalAlign="WindowCenter" PopupVerticalAlign="WindowCenter" 
                ClientInstanceName="popupAddEdit">
                <ContentCollection>
                    <dx:PopupControlContentControl runat="server">
                        <div class="popup-form">
                            <div class="form-group">
                                <label>CHP_GRP:</label>
                                <dx:ASPxComboBox ID="cboChpGrp" runat="server" Width="100%" DataSourceID="dsFlowMapping"
                                    TextField="CHP_GRP" ValueField="CHP_GRP" ClientInstanceName="cboChpGrp">
                                    <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                                </dx:ASPxComboBox>
                            </div>
                            <div class="form-group">
                                <label>LAYER:</label>
                                <dx:ASPxTextBox ID="txtLayer" runat="server" Width="100%" ClientInstanceName="txtLayer">
                                    <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                                </dx:ASPxTextBox>
                            </div>
                            <div class="form-group">
                                <label>OPE_NO:</label>
                                <dx:ASPxTextBox ID="txtOpeNo" runat="server" Width="100%" ClientInstanceName="txtOpeNo">
                                    <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                                </dx:ASPxTextBox>
                            </div>
                            <div class="form-group">
                                <label>PR:</label>
                                <dx:ASPxTextBox ID="txtPR" runat="server" Width="100%" ClientInstanceName="txtPR">
                                    <ValidationSettings RequiredField-IsRequired="true" RequiredField-ErrorText="必填欄位" />
                                </dx:ASPxTextBox>
                            </div>
                            <div class="form-group">
                                <label>頻率:</label>
                                <div class="frequency-container">
                                    <div>
                                        <dx:ASPxSpinEdit ID="seFrequencyCount" runat="server" Width="60px" MinValue="1" Value="1" ClientInstanceName="seFrequencyCount">
                                        </dx:ASPxSpinEdit>
                                    </div>
                                    <div>次 / </div>
                                    <div>
                                        <dx:ASPxComboBox ID="cboFrequencyType" runat="server" Width="80px" Value="天" ClientInstanceName="cboFrequencyType">
                                            <Items>
                                                <dx:ListEditItem Text="天" Value="天" />
                                                <dx:ListEditItem Text="週" Value="週" />
                                            </Items>
                                        </dx:ASPxComboBox>
                                    </div>
                                    <div>
                                        <dx:ASPxSpinEdit ID="seFrequencyValue" runat="server" Width="60px" MinValue="1" Value="1" ClientInstanceName="seFrequencyValue">
                                        </dx:ASPxSpinEdit>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right; margin-top: 20px;">
                                <dx:ASPxButton ID="btnSave" runat="server" Text="確定" AutoPostBack="false" Width="80px">
                                    <ClientSideEvents Click="function(s, e) { savePopupData(); }" />
                                </dx:ASPxButton>
                                <dx:ASPxButton ID="btnCancel" runat="server" Text="取消" AutoPostBack="false" Width="80px">
                                    <ClientSideEvents Click="function(s, e) { popupAddEdit.Hide(); }" />
                                </dx:ASPxButton>
                            </div>
                        </div>
                    </dx:PopupControlContentControl>
                </ContentCollection>
            </dx:ASPxPopupControl>
            
            <asp:SqlDataSource ID="dsFlowMapping" runat="server" ConnectionString="<%$ ConnectionStrings:OracleConnection %>"
                ProviderName="<%$ ConnectionStrings:OracleConnection.ProviderName %>"
                SelectCommand="SELECT DISTINCT CHP_GRP FROM FLOW_MAPPING ORDER BY CHP_GRP">
            </asp:SqlDataSource>
            
            <dx:ASPxHiddenField ID="hfEditedRows" runat="server" ClientInstanceName="hfEditedRows">
            </dx:ASPxHiddenField>
            
            <dx:ASPxCallback ID="callbackSaveAll" runat="server" ClientInstanceName="callbackSaveAll"
                OnCallback="callbackSaveAll_Callback">
                <ClientSideEvents CallbackComplete="function(s, e) {
                    if (e.result === 'Success') {
                        alert('資料儲存成功');
                        gridSpcToolRank.Refresh();
                    } else {
                        alert('資料儲存失敗: ' + e.result);
                    }
                }" />
            </dx:ASPxCallback>
        </div>
    </form>
    
    <script type="text/javascript">
        function searchGrid() {
            var searchText = txtSearch.GetText();
            gridSpcToolRank.ApplyFilter("CHP_GRP LIKE '%" + searchText + "%'");
        }
        
        function saveAllData() {
            var changedRows = JSON.stringify(gridSpcToolRank.cpChangedRows || []);
            hfEditedRows.Set('ChangedRows', changedRows);
            callbackSaveAll.PerformCallback();
        }
        
        function savePopupData() {
            var isValid = ASPxClientEdit.ValidateEditorsInContainer(popupAddEdit.GetContentDiv());
            if (!isValid) return;
            
            var newRow = {
                CHP_GRP: cboChpGrp.GetValue(),
                LAYER: txtLayer.GetText(),
                OPE_NO: txtOpeNo.GetText(),
                PR: txtPR.GetText(),
                FREQUENCY: seFrequencyCount.GetValue() + "次:" + seFrequencyValue.GetValue() + cboFrequencyType.GetValue()
            };
            
            // Add new row to grid
            gridSpcToolRank.AddNewRow(newRow);
            
            // Hide popup
            popupAddEdit.Hide();
        }
        
        function showAddPopup(copyRow) {
            if (copyRow) {
                var focusedRowIndex = gridSpcToolRank.GetFocusedRowIndex();
                var chpGrpValue = gridSpcToolRank.GetRowValues(focusedRowIndex, 'CHP_GRP');
                cboChpGrp.SetValue(chpGrpValue);
            } else {
                cboChpGrp.SetValue(null);
                txtLayer.SetText('');
                txtOpeNo.SetText('');
                txtPR.SetText('');
                seFrequencyCount.SetValue(1);
                cboFrequencyType.SetValue('天');
                seFrequencyValue.SetValue(1);
            }
            
            popupAddEdit.Show();
        }
    </script>
</body>
</html>