WITH combined_data AS (
    SELECT
        fabid,
        jobid,
        jobver,
        LISTAGG(chart_rule, ',') WITHIN GROUP (ORDER BY chart_rule) AS combined_column
    FROM (
        SELECT DISTINCT
            fabid,
            jobid,
            jobver,
            chart_type || ',' || ruleid AS chart_rule
        FROM
            rule_action
    )
    GROUP BY
        fabid,
        jobid,
        jobver
),
diff_data AS (
    SELECT
        fabid,
        jobid,
        jobver,
        combined_column,
        LEAD(jobver) OVER (PARTITION BY fabid, jobid ORDER BY jobver) AS next_jobver,
        LEAD(combined_column) OVER (PARTITION BY fabid, jobid ORDER BY jobver) AS next_combined_column
    FROM
        combined_data
),
changes AS (
    SELECT
        fabid,
        jobid,
        jobver AS version_1,
        combined_column AS combined_column_1,
        next_jobver AS version_2,
        next_combined_column AS combined_column_2,
        (
            SELECT LISTAGG(elem, ',') WITHIN GROUP (ORDER BY elem) FROM (
                SELECT elem FROM (
                    SELECT REGEXP_SUBSTR(combined_column_1, '[^,]+', 1, LEVEL) AS elem
                    FROM dual
                    CONNECT BY REGEXP_SUBSTR(combined_column_1, '[^,]+', 1, LEVEL) IS NOT NULL
                )
                MINUS
                SELECT elem FROM (
                    SELECT REGEXP_SUBSTR(next_combined_column, '[^,]+', 1, LEVEL) AS elem
                    FROM dual
                    CONNECT BY REGEXP_SUBSTR(next_combined_column, '[^,]+', 1, LEVEL) IS NOT NULL
                )
                UNION ALL
                SELECT elem FROM (
                    SELECT REGEXP_SUBSTR(next_combined_column, '[^,]+', 1, LEVEL) AS elem
                    FROM dual
                    CONNECT BY REGEXP_SUBSTR(next_combined_column, '[^,]+', 1, LEVEL) IS NOT NULL
                )
                MINUS
                SELECT elem FROM (
                    SELECT REGEXP_SUBSTR(combined_column_1, '[^,]+', 1, LEVEL) AS elem
                    FROM dual
                    CONNECT BY REGEXP_SUBSTR(combined_column_1, '[^,]+', 1, LEVEL) IS NOT NULL
                )
            )
        ) AS difference
    FROM
        diff_data
    WHERE
        combined_column <> next_combined_column
)
SELECT
    fabid,
    jobid,
    version_1,
    combined_column_1,
    version_2,
    combined_column_2,
    difference
FROM
    changes
ORDER BY
    fabid,
    jobid,
    version_1