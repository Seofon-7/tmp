WITH CombinedData AS (
    SELECT
        ra.fabid,
        ra.jobid,
        ra.jobver,
        ra.chart_type,
        LISTAGG(ra.ruleid, ',') WITHIN GROUP (ORDER BY ra.ruleid) AS ruleids
    FROM
        rule_action ra
    GROUP BY
        ra.fabid, ra.jobid, ra.jobver, ra.chart_type
),
CombinedChartTypeRuleid AS (
    SELECT
        fabid,
        jobid,
        jobver,
        LISTAGG(chart_type || ':' || ruleids, ',') WITHIN GROUP (ORDER BY chart_type) AS combined_chart_type_ruleid
    FROM
        CombinedData
    GROUP BY
        fabid, jobid, jobver
),
VersionPairs AS (
    SELECT
        c1.fabid,
        c1.jobid,
        c1.jobver AS jobver1,
        c2.jobver AS jobver2,
        c1.combined_chart_type_ruleid AS combined_chart_type_ruleid1,
        c2.combined_chart_type_ruleid AS combined_chart_type_ruleid2
    FROM
        CombinedChartTypeRuleid c1
        JOIN CombinedChartTypeRuleid c2 ON c1.fabid = c2.fabid AND c1.jobid = c2.jobid AND c1.jobver < c2.jobver
),
Differences AS (
    SELECT
        vp.fabid,
        vp.jobid,
        vp.jobver1,
        vp.jobver2,
        vp.combined_chart_type_ruleid1,
        vp.combined_chart_type_ruleid2,
        CASE
            WHEN ra1.combined_chart_type_ruleid IS NOT NULL AND ra2.combined_chart_type_ruleid IS NULL THEN 'Removed: ' || ra1.combined_chart_type_ruleid
            WHEN ra1.combined_chart_type_ruleid IS NULL AND ra2.combined_chart_type_ruleid IS NOT NULL THEN 'Added: ' || ra2.combined_chart_type_ruleid
            ELSE 'Changed from ' || ra1.combined_chart_type_ruleid || ' to ' || ra2.combined_chart_type_ruleid
        END AS difference_details
    FROM
        VersionPairs vp
        LEFT JOIN CombinedChartTypeRuleid ra1 ON vp.fabid = ra1.fabid AND vp.jobid = ra1.jobid AND vp.jobver1 = ra1.jobver
        LEFT JOIN CombinedChartTypeRuleid ra2 ON vp.fabid = ra2.fabid AND vp.jobid = ra2.jobid AND vp.jobver2 = ra2.jobver
    WHERE
        ra1.combined_chart_type_ruleid IS DISTINCT FROM ra2.combined_chart_type_ruleid
)
SELECT
    fabid,
    jobid,
    jobver1,
    jobver2,
    combined_chart_type_ruleid1,
    combined_chart_type_ruleid2,
    LISTAGG(difference_details, ', ') WITHIN GROUP (ORDER BY difference_details) AS differences
FROM
    Differences
GROUP BY
    fabid,
    jobid,
    jobver1,
    jobver2,
    combined_chart_type_ruleid1,
    combined_chart_type_ruleid2
ORDER BY
    fabid, jobid, jobver1, jobver2;
