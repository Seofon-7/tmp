WITH MVIEW_INFO AS (
  SELECT 
    MVIEW_NAME,
    REFRESH_MODE,
    REFRESH_METHOD,
    BUILD_MODE,
    LAST_REFRESH_TYPE,
    LAST_REFRESH_DATE,
    NEXT
  FROM USER_MVIEWS
  WHERE NEXT IS NOT NULL  -- MView 本身有設定 refresh 排程
),
JOBS_INFO AS (
  SELECT 
    TO_CHAR(JOB) AS JOB_ID,
    WHAT,
    NEXT_DATE,
    INTERVAL
  FROM DBA_JOBS
  WHERE WHAT LIKE '%MVIEW%' OR WHAT LIKE '%REFRESH%'
  UNION ALL
  SELECT 
    JOB_NAME AS JOB_ID,
    JOB_ACTION AS WHAT,
    NEXT_RUN_DATE AS NEXT_DATE,
    REPEAT_INTERVAL AS INTERVAL
  FROM DBA_SCHEDULER_JOBS
  WHERE JOB_ACTION LIKE '%MVIEW%' OR JOB_ACTION LIKE '%REFRESH%'
),
COMBINED AS (
  SELECT 
    M.MVIEW_NAME,
    M.REFRESH_MODE,
    M.REFRESH_METHOD,
    M.BUILD_MODE,
    M.LAST_REFRESH_TYPE,
    M.LAST_REFRESH_DATE,
    M.NEXT AS MVIEW_NEXT_REFRESH,
    J.JOB_ID AS JOB_NAME,
    J.NEXT_DATE AS JOB_NEXT_RUN,
    J.INTERVAL AS JOB_REPEAT_INTERVAL
  FROM MVIEW_INFO M
  LEFT JOIN JOBS_INFO J
    ON UPPER(J.WHAT) LIKE '%' || UPPER(M.MVIEW_NAME) || '%'
  UNION
  SELECT 
    NULL AS MVIEW_NAME,
    NULL, NULL, NULL, NULL, NULL,
    NULL AS MVIEW_NEXT_REFRESH,
    J.JOB_ID,
    J.NEXT_DATE,
    J.INTERVAL
  FROM JOBS_INFO J
  WHERE NOT EXISTS (
    SELECT 1 FROM USER_MVIEWS M
    WHERE UPPER(J.WHAT) LIKE '%' || UPPER(M.MVIEW_NAME) || '%'
  )
)
SELECT *
FROM COMBINED
WHERE MVIEW_NAME IS NOT NULL OR JOB_NAME IS NOT NULL
ORDER BY MVIEW_NAME NULLS LAST, JOB_NAME;